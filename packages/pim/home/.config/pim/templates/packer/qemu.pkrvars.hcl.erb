# Auto-generated by pim packer
# Build: <%= _build_name %>
# Generated: <%= _generated_at %>

vm_name          = "<%= _build_name %>"
iso_url          = "<%= _iso_path %>"
iso_checksum     = "<%= checksum %>"
output_directory = "<%= File.join(File.dirname(_output_path), _build_name) %>"
http_directory   = "<%= _http_dir %>"

disk_size        = "<%= disk_size || '20G' %>"
memory           = <%= memory || 2048 %>
cpus             = <%= cores || 2 %>

ssh_username     = "<%= ssh_username || username %>"
ssh_password     = "<%= ssh_password || password %>"
ssh_timeout      = "<%= ssh_timeout || '30m' %>"

boot_wait        = "<%= boot_wait || '5s' %>"
shutdown_command = "<%= shutdown_command || "echo '#{password}' | sudo -S shutdown -P now" %>"

headless         = <%= headless.nil? ? true : headless %>
<% if !headless && is_mac %>
display          = "cocoa"  # macOS native display
<% else %>
display          = "none"   # Use VNC
<% end %>
format           = "<%= output_format || 'qcow2' %>"
disk_interface   = "<%= disk_interface || 'virtio' %>"
net_device       = "<%= net_device || 'virtio-net' %>"

<%# Architecture detection based on ISO or explicit setting %>
<% 
  # Determine architecture from ISO filename or explicit setting
  arch = architecture || utm_architecture
  if arch.nil? && defined?(filename) && filename
    arch = filename.include?('arm64') ? 'arm64' : 'amd64'
  end
  arch ||= 'amd64'
  
  is_arm = (arch == 'arm64' || arch == 'aarch64')
  is_mac = RUBY_PLATFORM.include?('darwin')
%>

# Architecture: <%= arch %> on <%= is_mac ? 'macOS' : 'Linux' %>
<% if is_arm %>
qemu_binary      = "qemu-system-aarch64"
machine_type     = "virt"
cpu_type         = "<%= is_mac ? 'host' : 'cortex-a72' %>"
accelerator      = "<%= is_mac ? 'hvf' : (accelerator || 'kvm') %>"
efi_boot         = true
<% if is_mac %>
# macOS ARM64 EFI firmware paths (Homebrew)
efi_firmware_code = "/opt/homebrew/share/qemu/edk2-aarch64-code.fd"
efi_firmware_vars = "/opt/homebrew/share/qemu/edk2-arm-vars.fd"
<% else %>
# Linux ARM64 EFI firmware paths
efi_firmware_code = "/usr/share/AAVMF/AAVMF_CODE.fd"
efi_firmware_vars = "/usr/share/AAVMF/AAVMF_VARS.fd"
<% end %>
<% else %>
qemu_binary      = "qemu-system-x86_64"
machine_type     = "q35"
cpu_type         = "host"
accelerator      = "<%= is_mac ? 'hvf' : (accelerator || 'kvm') %>"
efi_boot         = false
efi_firmware_code = ""
efi_firmware_vars = ""
<% end %>

boot_command = [
<% if is_arm %>
  # ARM64 boot command - EFI/GRUB based
  "<wait60>",
  "c<wait>",
  "linux /install.a64/vmlinuz ",
  "auto=true ",
  "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
  "debian-installer=en_US.UTF-8 ",
  "locale=<%= locale || 'en_US.UTF-8' %> ",
  "keyboard-configuration/xkb-keymap=<%= keyboard || 'us' %> ",
  "netcfg/get_hostname=<%= hostname || 'packer' %> ",
  "netcfg/get_domain=<%= domain || 'local' %> ",
  "--- quiet<enter><wait>",
  "initrd /install.a64/initrd.gz<enter><wait>",
  "boot<enter>"
<% else %>
  # x86_64 boot command - BIOS based
  "<esc><wait>",
  "auto ",
  "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
  "debian-installer=en_US.UTF-8 ",
  "locale=<%= locale || 'en_US.UTF-8' %> ",
  "keyboard-configuration/xkb-keymap=<%= keyboard || 'us' %> ",
  "netcfg/get_hostname=<%= hostname || 'packer' %> ",
  "netcfg/get_domain=<%= domain || 'local' %> ",
  "<enter>"
<% end %>
]
